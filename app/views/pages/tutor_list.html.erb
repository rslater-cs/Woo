<h1>List of all Tutors</h1>

<%= form_with url: "", method: :get do |form| %>
  <%= form.label :query, "Filter:" %>
  <%= form.collection_select :query, TutorSubject.select(:subject).distinct, :subject, :subject, prompt: "Show All" %>
  <%= form.submit "Search" %>
<% end %>

<%
  @users = nil
  if params[:query].blank?
    @users = User.where(role: 'tutor')
  else
    @tutor_ids = TutorSubject.where(subject: params[:query]).select(:tutorID)
    @users = User.where(role: 'tutor', id: @tutor_ids)
  end
%>

<% @users.each do |tutor| %>
  <p><%= tutor.id %> <%= tutor.forename %> <%= tutor.surname %> <%= tutor.role %></p>
  <%
    subjects = "|"
    TutorSubject.where(tutorID: tutor.id).each do |subject|
      subjects += subject.subject
      subjects += "|"
    end
  %>
  <p><%= subjects %></p>

  <%= link_to "See Tutor Profile", user_path(tutor.id) %>
<% end %>
